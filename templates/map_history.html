{% extends "base.html" %}
{% block title %}History - {{ device.name }}{% endblock %}

{% block content %}

<div class="card p-3 shadow-sm mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label fw-bold">From</label>
      <input type="datetime-local" id="fromTime" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label fw-bold">To</label>
      <input type="datetime-local" id="toTime" class="form-control">
    </div>
    <div class="col-md-4">
      <button id="filterBtn" class="btn btn-primary w-100">
        <i class="bi bi-filter-circle"></i> Apply Filter
      </button>
    </div>
  </div>
  <div class="mt-2 text-center">
    <button class="btn btn-outline-secondary btn-sm quick-range" data-range="1h">Last 1 Hour</button>
    <button class="btn btn-outline-secondary btn-sm quick-range" data-range="6h">Last 6 Hours</button>
    <button class="btn btn-outline-secondary btn-sm quick-range" data-range="24h">Last 24 Hours</button>
    <button class="btn btn-outline-secondary btn-sm quick-range" data-range="today">Today</button>
  </div>
</div>

<div class="container mt-4">
  <div class="card shadow-lg border-0">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">üìç Trip History - <span class="text-primary">{{ device.name }}</span></h4>
      <span id="modeBadge" class="badge bg-secondary">History Mode</span>
    </div>
    <div class="card-body p-0">
      <div id="map" style="height: 600px; border-radius: 0 0 10px 10px;"></div>
    </div>
  </div>

  <div class="text-center mt-3">
    <button id="liveToggle" class="btn btn-info">
      <i class="bi bi-broadcast"></i> Enable Live Mode
    </button>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const deviceId = {{ device.id }};
  let map = L.map("map").setView([20.5937, 78.9629], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const icons = {
    car: L.icon({ iconUrl: "/static/icons/icons8-car-96.gif", iconSize: [45, 45], iconAnchor: [22, 45] }),
    truck: L.icon({ iconUrl: "/static/icons/icons8-truck-96.gif", iconSize: [45, 45], iconAnchor: [22, 45] }),
    bike: L.icon({ iconUrl: "/static/icons/motorcycle.gif", iconSize: [45, 45], iconAnchor: [22, 45] })
  };
  const icon = icons["{{ device.type or 'car' }}".toLowerCase()] || icons.car;

  let polyline = L.polyline([], { color: "blue" }).addTo(map);
  let marker = null;
  let liveMode = false;

  // === Function: Fetch filtered data ===
  async function fetchFilteredHistory(from, to) {
    const params = new URLSearchParams();
    if (from) params.append("from", from);
    if (to) params.append("to", to);

    const res = await fetch(`/api/history/${deviceId}?${params.toString()}`);
    return await res.json();
  }

  // === Function: Update map based on data ===
  function renderPath(data) {
    if (!data.length) return;

    polyline.setLatLngs(data.map(d => [d.latitude, d.longitude]));
    const last = data[data.length - 1];
    const latlng = [last.latitude, last.longitude];

    if (!marker) {
      marker = L.marker(latlng, { icon }).addTo(map);
      map.setView(latlng, 14);
    } else {
      marker.setLatLng(latlng);
    }
  }

  // === Filter button ===
  document.getElementById("filterBtn").onclick = async () => {
    const from = document.getElementById("fromTime").value;
    const to = document.getElementById("toTime").value;
    const data = await fetchFilteredHistory(from, to);
    renderPath(data);
  };

  // === Quick range buttons ===
  document.querySelectorAll(".quick-range").forEach(btn => {
    btn.onclick = async () => {
      const range = btn.dataset.range;
      const now = new Date();
      let from = new Date(now);
      if (range === "1h") from.setHours(now.getHours() - 1);
      else if (range === "6h") from.setHours(now.getHours() - 6);
      else if (range === "24h") from.setHours(now.getHours() - 24);
      else if (range === "today") from.setHours(0, 0, 0, 0);

      const data = await fetchFilteredHistory(from.toISOString(), now.toISOString());
      renderPath(data);
    };
  });

  // === Live toggle ===
  document.getElementById("liveToggle").onclick = () => {
    liveMode = !liveMode;
    const badge = document.getElementById("modeBadge");
    const btn = document.getElementById("liveToggle");
    if (liveMode) {
      badge.className = "badge bg-success";
      badge.textContent = "Live Mode";
      btn.innerHTML = '<i class="bi bi-stop-circle"></i> Disable Live Mode';
      updateMap();
    } else {
      badge.className = "badge bg-secondary";
      badge.textContent = "History Mode";
      btn.innerHTML = '<i class="bi bi-broadcast"></i> Enable Live Mode';
    }
  };

  // === Live updater ===

async function updateMap() {
  const fromTime = document.getElementById("fromTime")?.value || "";
  const toTime = document.getElementById("toTime")?.value || "";

  const query = new URLSearchParams();
  if (fromTime) query.append("from", fromTime);
  if (toTime) query.append("to", toTime);

  const res = await fetch(`/api/history/${deviceId}?${query.toString()}`);
  const data = await res.json();

  // Reset map visuals
  polyline.setLatLngs([]);
  if (marker) map.removeLayer(marker);

  if (!data || !data.length) {
    console.warn("No data returned from API");
    return;
  }

  // Use all valid points
  const coords = data
    .map(d => [parseFloat(d.latitude), parseFloat(d.longitude)])
    .filter(([lat, lon]) =>
      !isNaN(lat) && !isNaN(lon) &&
      lat >= -90 && lat <= 90 &&
      lon >= -180 && lon <= 180
    );

  if (coords.length < 2) {
    console.warn(`‚ö†Ô∏è Only ${coords.length} points available ‚Äî drawing single marker`);
    if (coords.length === 1) {
      marker = L.marker(coords[0], { icon }).addTo(map);
      map.setView(coords[0], 15);
    }
    return;
  }

  // Draw line & marker
  polyline.setLatLngs(coords);
  const last = coords[coords.length - 1];
  marker = L.marker(last, { icon }).addTo(map);
  map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
}


// Helper: Haversine distance
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}


document.getElementById("filterBtn").addEventListener("click", updateMap);

  setInterval(() => { if (liveMode) updateMap(); }, 3000);

  // Initial load (last 6h by default)
  (async () => {
    const now = new Date();
    const from = new Date(now);
    from.setHours(now.getHours() - 6);
    const data = await fetchFilteredHistory(from.toISOString(), now.toISOString());
    renderPath(data);
  })();
</script>
{% endblock %}
