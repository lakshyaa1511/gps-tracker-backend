{% set d = None %}
{% extends "base.html" %}
{% block title %}Devices Map{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">üìç All Devices</h2>

    <!-- Device Selector -->
    <div class="d-flex gap-2">
      <input type="text" id="searchBox" class="form-control" placeholder="üîé Search device..." style="width: 200px;">
      <select id="deviceSelector" class="form-select" style="width: 200px;">
        <option value="">-- Select Device --</option>
        {% for d in devices %}
        <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="map" style="height: 600px; border-radius: 10px;"></div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
  // Device data from Flask
  var devices = {{ devices | tojson | safe }};
  var map = L.map("map", { fullscreenControl: true }).setView([20.5937, 78.9629], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  L.control.locate({ position: "topleft", strings: { title: "Show my location" } }).addTo(map);

  // Custom icons for each type
  const icons = {
    car: L.icon({
      iconUrl: "/static/icons/icons8-car-96.gif",
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -30]
    }),
    bike: L.icon({
      iconUrl: "/static/icons/motorcycle.gif",
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -30]
    }),
    truck: L.icon({
      iconUrl: "/static/icons/icons8-truck-96.gif",
      iconSize: [45, 45],
      iconAnchor: [22, 45],
      popupAnchor: [0, -35]
    }),
    default: L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/743/743922.png",
      iconSize: [35, 35],
      iconAnchor: [17, 35],
      popupAnchor: [0, -30]
    })
  };

  var markers = {};

  function getDeviceIcon(type) {
    if (!type) return icons.default;
    type = type.toLowerCase();
    if (type.includes("car")) return icons.car;
    if (type.includes("bike") || type.includes("motor")) return icons.bike;
    if (type.includes("truck")) return icons.truck;
    return icons.default;
  }

  function renderDevices() {
    let bounds = [];

    devices.forEach(device => {
      if (!device.latitude || !device.longitude) return;

      const latlng = [device.latitude, device.longitude];
      bounds.push(latlng);

      const diff = (new Date() - new Date(device.timestamp)) / 1000;
      const status = diff < 60 ? "üü¢ Online" : "üî¥ Offline";

      if (markers[device.id]) {
        markers[device.id].setLatLng(latlng);
      } else {
        const icon = getDeviceIcon(device.type);
        markers[device.id] = L.marker(latlng, { icon }).addTo(map)
          .bindPopup(`
            <strong>${device.name}</strong><br>
            Type: ${device.type || "Unknown"}<br>
            Lat: ${latlng[0].toFixed(5)}, Lng: ${latlng[1].toFixed(5)}<br>
            Status: ${status}
          `);
      }
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [50, 50] });
  }

  // Search & zoom to device
  document.getElementById("deviceSelector").addEventListener("change", e => {
    const id = e.target.value;
    const device = devices.find(x => x.id == id);
    if (device && device.latitude && device.longitude) {
      map.setView([device.latitude, device.longitude], 15);
      markers[device.id]?.openPopup();
    }
  });

  document.getElementById("searchBox").addEventListener("input", e => {
    const val = e.target.value.toLowerCase();
    const found = devices.find(d => d.name.toLowerCase().includes(val));
    if (found && found.latitude && found.longitude) {
      map.setView([found.latitude, found.longitude], 15);
      markers[found.id]?.openPopup();
    }
  });

  // Legend
  var legend = L.control({ position: "bottomright" });
  legend.onAdd = function () {
    var div = L.DomUtil.create("div", "card p-2 shadow-sm");
    div.innerHTML = `
      <strong>Legend</strong><br>
      <img src="/static/icons/icons8-car-96.gif" width="25"> Car<br>
      <img src="/static/icons/motorcycle.gif" width="25"> Bike<br>
      <img src="/static/icons/icons8-truck-96.gif" width="25"> Truck<br>
      üü¢ Online<br>
      üî¥ Offline
    `;
    return div;
  };
  legend.addTo(map);

  // Initial render
  renderDevices();

  // Refresh every 5 seconds
  setInterval(async () => {
    const res = await fetch("/api/devices");
    devices = await res.json();
    renderDevices();
  }, 5000);
</script>
{% endblock %}
